<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="TransLink Forecasting">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Custom Data Generation - RTM</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../css/extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Custom Data Generation";
    var mkdocs_page_input_path = "data_generate.md";
    var mkdocs_page_url = "/rtmdoc/data_generate/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', '', 'auto');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> RTM</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <span class="caption-text">User Guide</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../workflow/">Model Workflow</a>
                </li>
                <li class="">
                    
    <a class="" href="../data_outputs/">Model Data Output</a>
                </li>
                <li class="">
                    
    <a class="" href="../data_analysis/">Model Data Analysis</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Custom Data Generation</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#custom-data-generation">Custom Data Generation</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#python-script-vs-modeller-tool">Python script vs modeller tool</a></li>
        
            <li><a class="toctree-l4" href="#example-tool-for-pa-to-od">Example Tool for PA to OD</a></li>
        
            <li><a class="toctree-l4" href="#using-the-notebook">Using the notebook</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">About</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../about/contributing/">Contributing</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">RTM</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>User Guide &raquo;</li>
        
      
    
    <li>Custom Data Generation</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="custom-data-generation">Custom Data Generation<a class="headerlink" href="#custom-data-generation" title="Permanent link">&para;</a></h1>
<h2 id="python-script-vs-modeller-tool">Python script vs modeller tool<a class="headerlink" href="#python-script-vs-modeller-tool" title="Permanent link">&para;</a></h2>
<p>In general Modeller tools more polished and can provide a GUI, but take more time and effort to prepare.  They can still be called from other places and imported into other files.  We generally use these for production grade, stable solutions, that we intend to use repeatedly.  Object oriented.  It is expected that everyone here knows how to use a modeller tool</p>
<p>Python script can be built easily and often is enough to quickly complete a task at hand.  Maybe fragile, can break with simple model changes.  These may not be maintained.  These can work will with the notebooks.   They can just work with basic functions, easy to put together a basic but reproducible analysis.  </p>
<h3 id="executing-a-python-script-from-the-emme-ipython-shell">Executing a python script from the EMME iPython shell<a class="headerlink" href="#executing-a-python-script-from-the-emme-ipython-shell" title="Permanent link">&para;</a></h3>
<p>Open the ipython modeller shell in EMME desktop</p>
<p><img alt="openshell" src="../img/data_generation/shell_00_pulldown.png" /></p>
<p>Once in the shell, navigate to location of the subject script.  In this case the script in question is located in the <code>RTM/Scripts/Tools</code> directory</p>
<p><img alt="navigate" src="../img/data_generation/shell_01_natviate.png" /></p>
<p>Check the files in this directory to ensure we have the one we want, then we can use the iPython magic <code>%run &lt;filename.py&gt;</code> to execute our script</p>
<p><img alt="lsrun" src="../img/data_generation/shell_02_ls_and_run.png" /></p>
<h2 id="example-tool-for-pa-to-od">Example Tool for PA to OD<a class="headerlink" href="#example-tool-for-pa-to-od" title="Permanent link">&para;</a></h2>
<p>As a general rule in trip based modeling production/attraction (PA) trips can be converted to origin/destination (OD) trips roughly by <code>0.5 * (mat + mat')</code>.  However, for a variety of reasons, most notably non-home-based (NHB) trips, not everything is completely symmetrical.  Production to attraction blending factors have been calculated from the trip diary for the RTM skims.  </p>
<p>The example runs the <code>PA2OD.py</code> python script with the output directed to the <code>trip_summaries.db</code> database.  Once you have run the script, navigate to <code>RTM/&lt;your_db_folder&gt;</code> and open the trip_summaries.db in your sqlite viewer.  </p>
<p><img alt="opents" src="../img/data_generation/pad2od_00_opentrip_summaries.png" /></p>
<p>Once there, we will see a new table named <code>od_daily_&lt;your ensemble if any&gt;</code></p>
<p><img alt="findtable" src="../img/data_generation/pad2od_01_find_table.png" /></p>
<p>From there we can query and view the results</p>
<p><img alt="querytable" src="../img/data_generation/pad2od_02_query.png" /></p>
<h3 id="why-does-it-run">Why does it run?<a class="headerlink" href="#why-does-it-run" title="Permanent link">&para;</a></h3>
<pre><code class="python">    if __name__ == '__main__':

    eb = _m.Modeller().emmebank
    # run with ensemble name and ensem_agg = True to aggregate
    # run with no ensemble name and ensem_agg = False to get TAZ level results
    # note, TAZ level results create very large file
    main(eb, ensem='gy', ensem_agg=True)
</code></pre>

<p>And why does this work?  See this video on <a href="https://www.youtube.com/watch?v=sugvnHA7ElY">YouTube Name and Main</a></p>
<h2 id="using-the-notebook">Using the notebook<a class="headerlink" href="#using-the-notebook" title="Permanent link">&para;</a></h2>
<p>The EMME Notebook is a powerful tool to generate results and summary data across many model runs. To demonstrate this, we took the base case model and varied the park and ride price on a particular park and ride lot. We run a separate model run for each park and ride price point. Then, we summarized the result across all of these model runs.</p>
<h3 id="connect-to-emme-modeler">Connect to EMME Modeler<a class="headerlink" href="#connect-to-emme-modeler" title="Permanent link">&para;</a></h3>
<p>When working with Jupyter Notebook within EMME, you need to import some basic libraries and toolboxes first, then connect to EMME desktop and databank.</p>
<pre><code class="python">import inro.modeller as _m
import inro.emme.desktop as _d
import csv
import os
import multiprocessing
import numpy as np
import pandas as pd
import sqlite3
import traceback as _traceback
import shutil

# connect to EMME
dt = _m.Modeller().desktop
de = dt.data_explorer()
db = de.active_database()
ebs = de.databases()

# load toolbox
util = _m.Modeller().tool(&quot;translink.util&quot;)

</code></pre>

<h3 id="listing-databanks">Listing databanks<a class="headerlink" href="#listing-databanks" title="Permanent link">&para;</a></h3>
<p>Within the Notebook scripting environment, you have access to all of the databank that is loaded in your project, you can list them all to verify.</p>
<pre><code class="python"># make sure modeller is closed or it will print to the python console in there
counter = 0
for eb in ebs:
    print counter, eb.title()
    counter += 1
</code></pre>

<pre><code class="text">0 Minimal Base Databank
1 pnr_bp_2016_250
2 pnr_bp_2016_300
</code></pre>

<h3 id="build-functions">Build functions<a class="headerlink" href="#build-functions" title="Permanent link">&para;</a></h3>
<p>To retrieve results from multiple runs, you should build a function to systematically get the results. In our example, we will get the lot usage at all park and ride lot, and export the results to csv.</p>
<pre><code class="python">def get_all_pnr_usage(eb):
    scenario_tag = str(util.get_eb_path(eb).split('\\')[-1].split('_')[-1])

    df = util.get_pd_ij_df(eb)

    df['price'] = scenario_tag

    df['pnr_usage'] = (util.get_matrix_numpy(eb, &quot;mf3000&quot;).flatten() +
                       util.get_matrix_numpy(eb, &quot;mf3001&quot;).flatten() +
                       util.get_matrix_numpy(eb, &quot;mf3002&quot;).flatten()) / 2

    df = df[(df['j'] &gt;99) &amp; (df['j'] &lt; 999)]

    return (df)


# initialize dataframe, ij from any eb
all_pnr_usage = pd.DataFrame()

# loop to get result
for eb in ebs:
    title = eb.title()

    if title == 'Minimal Base Databank':
        continue

    eb.open()
    eb = _m.Modeller().emmebank

    if all_pnr_usage.empty:
        all_pnr_usage = get_all_pnr_usage(eb)
    else:
        all_pnr_usage = pd.concat([all_pnr_usage, get_all_pnr_usage(eb)], axis=0)

all_pnr_usage_summary = all_pnr_usage.groupby(
    ['price', 'j']).sum()[['pnr_usage']].reset_index().pivot_table(
        values='pnr_usage', index='j', columns='price').fillna(0)

# export result for all pnr lot usage
import datetime
all_pnr_usage_summary.to_csv(
    'Bridgeport_pnr_all_lot_usage_result_' +
    datetime.datetime.today().strftime('%Y-%m-%d') + '.csv',
    index=True)
</code></pre>

<p>Here is a snippet of the output data:</p>
<table>
<thead>
<tr>
<th>j</th>
<th>300</th>
<th>350</th>
<th>...</th>
</tr>
</thead>
<tbody>
<tr>
<td>101</td>
<td>0</td>
<td>0</td>
<td>...</td>
</tr>
<tr>
<td>102</td>
<td>235.7</td>
<td>235.2</td>
<td>...</td>
</tr>
<tr>
<td>103</td>
<td>2.6</td>
<td>2.6</td>
<td>...</td>
</tr>
<tr>
<td>104</td>
<td>341.4</td>
<td>342.4</td>
<td>...</td>
</tr>
<tr>
<td>105</td>
<td>0</td>
<td>0</td>
<td>...</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
</tbody>
</table>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../about/contributing/" class="btn btn-neutral float-right" title="Contributing">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../data_analysis/" class="btn btn-neutral" title="Model Data Analysis"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright &copy; 2020 TransLink Forecasting</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/TransLinkForecasting/rtmdoc" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../data_analysis/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../about/contributing/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
